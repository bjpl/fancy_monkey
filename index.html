<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Fancy Monkey - Exclusive people clothes drops. Limited pieces. Timeless design.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Fancy Monkey</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            cursor: url('assets/banana-cursor.png') 16 16, auto;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            cursor: url('assets/banana-cursor.png') 16 16, auto;
        }

        a, button, .size-btn, .buy-btn {
            cursor: url('assets/banana-cursor.png') 16 16, pointer !important;
        }

        header {
            padding: 2rem 1rem;
            text-align: center;
            border-bottom: 1px solid #000;
        }

        .logo {
            width: 120px;
            height: auto;
            margin: 0 auto 1rem;
            display: block;
        }

        h1 {
            font-size: 2rem;
            letter-spacing: 0.2em;
            font-weight: 900;
        }

        .tagline {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .drop-info {
            padding: 1rem;
            text-align: center;
            background: #000;
            color: #fff;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
        }

        .products {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .product {
            text-align: center;
        }

        .product img {
            width: 100%;
            height: auto;
            aspect-ratio: 1;
            object-fit: cover;
            background: #f5f5f5;
            border: 1px solid #000;
            -webkit-user-drag: none;
            user-select: none;
            cursor: zoom-in;
            transition: transform 0.3s ease;
        }

        .product img:hover {
            transform: scale(1.02);
        }

        .product-info {
            padding: 1rem 0;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .product-price {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .product-fit {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .size-selector {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .size-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .size-btn:hover:not(.sold-out) {
            background: #000;
            color: #fff;
        }

        .size-btn.selected {
            background: #000;
            color: #fff;
        }

        .size-btn.sold-out {
            opacity: 0.3;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .buy-btn {
            width: 100%;
            padding: 1rem;
            background: #000;
            color: #fff;
            border: none;
            font-size: 1rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 700;
            transition: opacity 0.2s;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .buy-btn:hover:not(:disabled) {
            opacity: 0.8;
        }

        .buy-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .buy-btn.loading {
            position: relative;
            color: transparent;
        }

        .buy-btn.loading::after {
            content: 'Checking availability...';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 0.9rem;
        }

        /* Fun Error Handling UI */
        .error-message {
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-radius: 12px;
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .error-message::before {
            content: 'üêµ';
            position: absolute;
            font-size: 60px;
            opacity: 0.1;
            right: 10px;
            top: 50%;
            transform: translateY(-50%) rotate(-15deg);
        }

        .error-message.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .error-message.warning::before {
            content: 'üôà';
        }

        .error-message.success {
            background: linear-gradient(135deg, #667eea 0%, #48bb78 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .error-message.success::before {
            content: 'üôä';
        }

        .error-message.info {
            background: linear-gradient(135deg, #667eea 0%, #4299e1 100%);
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
        }

        .error-message.info::before {
            content: 'üôâ';
        }

        .error-message-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            letter-spacing: 0.05em;
        }

        .error-message-text {
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .error-message-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .error-action-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .error-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .error-action-btn.primary {
            background: rgba(255, 255, 255, 0.9);
            color: #764ba2;
        }

        .error-action-btn.primary:hover {
            background: rgba(255, 255, 255, 1);
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-20px);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .error-message.shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Connection Status Banner */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 0.75rem;
            background: #fff3cd;
            color: #856404;
            text-align: center;
            font-size: 0.9rem;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .connection-status.show {
            transform: translateY(0);
        }

        .connection-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.online {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.development {
            background: #cce5ff;
            color: #004085;
        }

        .status-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-icon.offline {
            background: #dc3545;
        }

        .status-icon.online {
            background: #28a745;
        }

        .status-icon.development {
            background: #007bff;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .product-skeleton {
            height: 400px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        /* Retry Button */
        .retry-button {
            padding: 0.75rem 1.5rem;
            background: #000;
            color: #fff;
            border: none;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            cursor: pointer;
            text-transform: uppercase;
            margin: 0.5rem;
            transition: opacity 0.2s;
        }

        .retry-button:hover {
            opacity: 0.8;
        }

        .retry-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dev Mode Badge */
        .dev-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
            z-index: 999;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dev-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
        }

        .dev-badge.hidden {
            display: none;
        }

        .sold-out-message {
            padding: 1rem;
            background: #f5f5f5;
            text-align: center;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .monkey-section {
            text-align: center;
            padding: 3rem 1rem 2rem;
        }

        .monkey-graphic {
            width: 250px;
            height: auto;
            max-width: 80%;
            margin: 0 auto;
            display: block;
            transition: transform 0.3s ease;
        }

        .monkey-graphic:hover {
            transform: scale(1.05);
        }

        @media (max-width: 640px) {
            .monkey-graphic {
                width: 180px;
            }
        }

        footer {
            border-top: 1px solid #000;
            padding: 2rem 1rem;
            text-align: center;
            font-size: 0.85rem;
        }

        .footer-section {
            margin: 1rem 0;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }

        .footer-links a {
            color: #000;
            text-decoration: none;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        .legal {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #ccc;
            color: #666;
            font-size: 0.8rem;
        }

        /* Category Filter Styles */
        .filter-section {
            border-bottom: 1px solid #000;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .filter-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filter-title {
            font-size: 0.85rem;
            letter-spacing: 0.15em;
            font-weight: 700;
            margin: 0;
        }

        .filter-clear {
            background: none;
            border: none;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            text-decoration: underline;
            cursor: pointer;
            padding: 0;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .filter-clear:hover {
            opacity: 0.6;
        }

        .filter-pills {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.25rem;
            scrollbar-width: thin;
            scrollbar-color: #000 transparent;
        }

        .filter-pills::-webkit-scrollbar {
            height: 4px;
        }

        .filter-pills::-webkit-scrollbar-track {
            background: transparent;
        }

        .filter-pills::-webkit-scrollbar-thumb {
            background: #000;
            border-radius: 2px;
        }

        .filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-weight: 500;
        }

        .filter-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: #000;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .filter-pill:hover::before {
            width: 100%;
        }

        .filter-pill:hover {
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .filter-pill.active {
            background: #000;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .filter-pill.active::before {
            width: 100%;
        }

        .filter-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 4px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            transition: all 0.3s;
        }

        .filter-pill:hover .filter-count,
        .filter-pill.active .filter-count {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Product Card Animations */
        .product {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .product.hidden {
            opacity: 0;
            transform: translateY(20px);
            display: none;
        }

        .product.filtering {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* No Results Message */
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .no-results h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #000;
        }

        @media (max-width: 640px) {
            h1 {
                font-size: 1.5rem;
            }

            .products {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .filter-section {
                position: static;
            }

            .filter-container {
                padding: 1rem;
            }

            .filter-pill {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }
        }

        .maintenance-notice {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            text-align: center;
            padding: 2rem;
        }

        .maintenance-notice.active {
            display: flex;
        }

        /* Lightbox Styles */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 10000;
            cursor: zoom-out;
        }

        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .lightbox.active .lightbox-content {
            transform: scale(1);
        }

        .lightbox img {
            max-width: 100%;
            max-height: 90vh;
            width: auto;
            height: auto;
            display: block;
            border: 2px solid #fff;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            cursor: default;
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            width: 40px;
            height: 40px;
            background: transparent;
            border: 2px solid #fff;
            color: #fff;
            font-size: 24px;
            font-weight: 300;
            line-height: 36px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        }

        .lightbox-close:hover {
            background: #fff;
            color: #000;
            transform: rotate(90deg);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            color: #000;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .lightbox-nav:hover {
            background: #000;
            color: #fff;
        }

        .lightbox-nav.prev {
            left: 20px;
        }

        .lightbox-nav.next {
            right: 20px;
        }

        .lightbox-nav.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .lightbox-nav.disabled:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }

        .lightbox-caption {
            position: absolute;
            bottom: -40px;
            left: 0;
            right: 0;
            text-align: center;
            color: #fff;
            font-size: 14px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        @media (max-width: 640px) {
            .lightbox-close {
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.5);
            }

            .lightbox-nav {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .lightbox-nav.prev {
                left: 10px;
            }

            .lightbox-nav.next {
                right: 10px;
            }

            .lightbox-caption {
                bottom: 10px;
                background: rgba(0, 0, 0, 0.7);
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Banner -->
    <div class="connection-status" id="connectionStatus">
        <span class="status-icon"></span>
        <span id="statusMessage">Checking connection...</span>
    </div>

    <!-- Development Mode Badge -->
    <div class="dev-badge hidden" id="devBadge">
        DEV MODE
    </div>

    <header>
        <img src="assets/logo.png" alt="Fancy Monkey" class="logo">
        <h1>FANCY MONKEY</h1>
        <p class="tagline">Exclusive People Clothes</p>
    </header>

    <div class="drop-info" id="dropInfo">
        NEXT DROP: FRIDAY MIDNIGHT EST
    </div>

    <!-- Search Section -->
    <section class="search-section">
        <div class="search-container">
            <div class="search-box">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="8.5" cy="8.5" r="6.5" stroke="currentColor" stroke-width="2"/>
                    <path d="M13 13L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <input
                    type="text"
                    id="searchInput"
                    class="search-input"
                    placeholder="Search for products, styles, or fits..."
                    autocomplete="off"
                    aria-label="Search products"
                />
                <button class="search-clear" id="searchClear" style="display: none;" aria-label="Clear search">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="search-info" id="searchInfo" style="display: none;">
                <span id="searchCount"></span>
            </div>
            <div class="search-history" id="searchHistory" style="display: none;">
                <!-- Recent searches will appear here -->
            </div>
        </div>
    </section>

    <!-- Category Filter Section -->
    <section class="filter-section">
        <div class="filter-container">
            <div class="filter-header">
                <h2 class="filter-title">COLLECTIONS</h2>
                <button class="filter-clear" id="clearFilter" style="display: none;">
                    CLEAR FILTER
                </button>
            </div>
            <div class="filter-pills" id="filterPills">
                <!-- Category pills will be loaded here -->
            </div>
        </div>
    </section>

    <main class="products" id="products">
        <!-- Products will be loaded here -->
    </main>

    <div class="monkey-section">
        <img src="assets/monkey_full.png" alt="Fancy Monkey Mascot" class="monkey-graphic">
    </div>

    <footer>
        <div class="footer-section">
            <strong>CUSTOMER SERVICE</strong><br>
            Email: help@fancymonkey.com<br>
            Instagram: @fancymonkey<br>
            Response time: Within 24 hours
        </div>

        <div class="footer-section">
            <strong>SHIPPING</strong><br>
            US Only (International coming soon)<br>
            Processing: 1-3 business days<br>
            Shipping: USPS/UPS with tracking<br>
            You will receive tracking within 48 hours
        </div>

        <div class="footer-links">
            <a href="#size-chart">Size Chart</a>
            <a href="#returns">Returns</a>
            <a href="https://instagram.com/fancymonkey" target="_blank">Instagram</a>
        </div>

        <div class="legal">
            <p>All prices in USD. Tax calculated at checkout.</p>
            <p>14-day returns on unworn items. See return policy for details.</p>
            <p>By purchasing, you agree to our terms and conditions.</p>
            <p>¬© 2024 Fancy Monkey. All rights reserved.</p>
        </div>
    </footer>

    <div class="maintenance-notice" id="maintenance">
        <div>
            <h2>Site Under Maintenance</h2>
            <p>We'll be back shortly. Follow @fancymonkey for updates.</p>
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" id="lightbox-close">√ó</button>
            <button class="lightbox-nav prev" id="lightbox-prev">‚Äπ</button>
            <button class="lightbox-nav next" id="lightbox-next">‚Ä∫</button>
            <img id="lightbox-image" src="" alt="">
            <div class="lightbox-caption" id="lightbox-caption"></div>
        </div>
    </div>

    <script>
        // ========== Configuration & State ==========
        let products = [];
        let selectedSizes = {};
        let activeFilter = 'all';
        let categories = {};

        // Environment Detection
        const ENV = {
            isDevelopment: window.location.hostname === 'localhost' ||
                          window.location.hostname === '127.0.0.1' ||
                          window.location.hostname.includes('github.io'),
            isProduction: window.location.hostname === 'fancymonkey.shop',
            checkoutApiUrl: 'https://fancymonkey-checkout.vercel.app/api/checkout',
            maxRetries: 3,
            retryDelay: 1000 // Base delay for exponential backoff
        };

        // ========== Shopping Cart Persistence Manager ==========
        class CartPersistenceManager {
            constructor() {
                this.storageKey = 'fancymonkey_cart';
                this.versionKey = 'fancymonkey_cart_version';
                this.currentVersion = '1.0.0';
                this.cartTTL = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
                this.isSupported = this.checkLocalStorageSupport();
            }

            // Check if localStorage is supported and available
            checkLocalStorageSupport() {
                try {
                    const testKey = '__fancymonkey_test__';
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                    return true;
                } catch (e) {
                    console.warn('LocalStorage not available:', e);
                    return false;
                }
            }

            // Save cart to localStorage with error handling
            saveCart(cart) {
                if (!this.isSupported) {
                    console.warn('Cart persistence disabled - localStorage not available');
                    return false;
                }

                try {
                    const cartData = {
                        version: this.currentVersion,
                        timestamp: Date.now(),
                        cart: cart,
                        expiresAt: Date.now() + this.cartTTL
                    };

                    localStorage.setItem(this.storageKey, JSON.stringify(cartData));
                    localStorage.setItem(this.versionKey, this.currentVersion);

                    if (ENV.isDevelopment) {
                        console.log('Cart saved:', cartData);
                    }

                    return true;
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.error('LocalStorage quota exceeded - clearing old data');
                        this.clearCart();
                        return false;
                    } else {
                        console.error('Failed to save cart:', e);
                        return false;
                    }
                }
            }

            // Load cart from localStorage
            loadCart() {
                if (!this.isSupported) {
                    return null;
                }

                try {
                    const storedData = localStorage.getItem(this.storageKey);

                    if (!storedData) {
                        return null;
                    }

                    const cartData = JSON.parse(storedData);

                    // Check version compatibility
                    if (cartData.version !== this.currentVersion) {
                        console.warn('Cart version mismatch - migrating data');
                        return this.migrateCart(cartData);
                    }

                    // Check if cart has expired
                    if (Date.now() > cartData.expiresAt) {
                        console.log('Cart expired - clearing');
                        this.clearCart();
                        return null;
                    }

                    if (ENV.isDevelopment) {
                        const ageHours = ((Date.now() - cartData.timestamp) / (1000 * 60 * 60)).toFixed(1);
                        console.log(`Cart restored (${ageHours}h old):`, cartData.cart);
                    }

                    return cartData.cart;
                } catch (e) {
                    console.error('Failed to load cart:', e);
                    this.clearCart();
                    return null;
                }
            }

            // Clear cart from localStorage
            clearCart() {
                if (!this.isSupported) {
                    return;
                }

                try {
                    localStorage.removeItem(this.storageKey);
                    if (ENV.isDevelopment) {
                        console.log('Cart cleared from localStorage');
                    }
                } catch (e) {
                    console.error('Failed to clear cart:', e);
                }
            }

            // Migrate cart from older versions (future-proofing)
            migrateCart(oldCartData) {
                try {
                    // For now, just update version and preserve data
                    // In future versions, add migration logic here
                    const migratedCart = {
                        version: this.currentVersion,
                        timestamp: oldCartData.timestamp || Date.now(),
                        cart: oldCartData.cart || oldCartData, // Handle old format
                        expiresAt: oldCartData.expiresAt || (Date.now() + this.cartTTL)
                    };

                    this.saveCart(migratedCart.cart);
                    return migratedCart.cart;
                } catch (e) {
                    console.error('Failed to migrate cart:', e);
                    this.clearCart();
                    return null;
                }
            }

            // Get cart age in hours
            getCartAge() {
                if (!this.isSupported) {
                    return null;
                }

                try {
                    const storedData = localStorage.getItem(this.storageKey);
                    if (!storedData) {
                        return null;
                    }

                    const cartData = JSON.parse(storedData);
                    const ageMs = Date.now() - cartData.timestamp;
                    return ageMs / (1000 * 60 * 60); // Convert to hours
                } catch (e) {
                    return null;
                }
            }

            // Get time until cart expires
            getTimeUntilExpiry() {
                if (!this.isSupported) {
                    return null;
                }

                try {
                    const storedData = localStorage.getItem(this.storageKey);
                    if (!storedData) {
                        return null;
                    }

                    const cartData = JSON.parse(storedData);
                    const timeLeft = cartData.expiresAt - Date.now();
                    return timeLeft > 0 ? timeLeft : 0;
                } catch (e) {
                    return null;
                }
            }

            // Check if cart exists and is valid
            hasValidCart() {
                if (!this.isSupported) {
                    return false;
                }

                try {
                    const storedData = localStorage.getItem(this.storageKey);
                    if (!storedData) {
                        return false;
                    }

                    const cartData = JSON.parse(storedData);
                    return Date.now() <= cartData.expiresAt;
                } catch (e) {
                    return false;
                }
            }
        }

        // Initialize cart persistence manager
        const cartPersistence = new CartPersistenceManager();

        // Connection State
        const connectionState = {
            online: navigator.onLine,
            apiAvailable: false,
            stripeConfigured: false,
            lastCheck: null
        };

        // ========== Error Handling System ==========
        class ErrorHandler {
            constructor() {
                this.retryAttempts = {};
                this.errorLog = [];
            }

            // PATTERN: Centralized error handling with context
            handle(error, context = {}) {
                const errorInfo = {
                    timestamp: new Date().toISOString(),
                    message: error.message || error,
                    context,
                    stack: error.stack,
                    userAgent: navigator.userAgent
                };

                this.errorLog.push(errorInfo);
                console.error('Error occurred:', errorInfo);

                // Route to appropriate handler based on error type
                if (error.name === 'NetworkError' || !navigator.onLine) {
                    return this.handleNetworkError(error, context);
                } else if (error.status === 404) {
                    return this.handleNotFoundError(error, context);
                } else if (error.status === 500 || error.status === 503) {
                    return this.handleServerError(error, context);
                } else if (error.message?.includes('Stripe')) {
                    return this.handleStripeError(error, context);
                } else {
                    return this.handleGenericError(error, context);
                }
            }

            handleNetworkError(error, context) {
                const messages = [
                    "Oops! The monkeys can't find the internet!",
                    "Our banana phone line is down!",
                    "The wifi bananas need recharging!"
                ];
                return {
                    title: 'üôà Connection Gone Bananas',
                    message: messages[Math.floor(Math.random() * messages.length)],
                    subtitle: 'Check your internet and we\'ll swing back into action',
                    action: 'retry',
                    severity: 'warning'
                };
            }

            handleServerError(error, context) {
                return {
                    title: 'üêµ Monkey Business Detected',
                    message: ENV.isDevelopment ?
                        'Our checkout monkeys are still learning! They\'ll be trained soon.' :
                        'Too many monkeys shopping at once!',
                    subtitle: ENV.isDevelopment ?
                        'Development mode - Checkout coming soon' :
                        'Give us a banana break and try again',
                    action: 'retry',
                    severity: 'info'
                };
            }

            handleStripeError(error, context) {
                return {
                    title: 'üçå Payment Banana Not Ripe Yet',
                    message: ENV.isDevelopment ?
                        'Our payment monkeys are still setting up shop!' :
                        'The payment tree is being watered',
                    subtitle: 'We\'ll have a backup banana ready in 3 seconds...',
                    action: 'fallback',
                    severity: 'warning'
                };
            }

            handleNotFoundError(error, context) {
                return {
                    title: 'üôä Lost in the Jungle',
                    message: 'We couldn\'t find that banana tree!',
                    subtitle: 'Let\'s try a different path',
                    action: 'fallback',
                    severity: 'warning'
                };
            }

            handleGenericError(error, context) {
                const funMessages = [
                    "A monkey wrench in our plans!",
                    "Banana peel on the checkout floor!",
                    "Our monkeys need a coffee break!"
                ];
                return {
                    title: 'üôâ Monkey See, Monkey... Oops!',
                    message: ENV.isDevelopment ?
                        `Tech speak: ${error.message || 'Unknown banana error'}` :
                        funMessages[Math.floor(Math.random() * funMessages.length)],
                    subtitle: 'Don\'t worry, we\'re on it!',
                    action: 'retry',
                    severity: 'info'
                };
            }

            // PATTERN: Exponential backoff with jitter
            async retry(fn, context = {}, attempt = 0) {
                const key = context.key || fn.toString();

                try {
                    const result = await fn();
                    this.retryAttempts[key] = 0;
                    return result;
                } catch (error) {
                    this.retryAttempts[key] = (this.retryAttempts[key] || 0) + 1;

                    if (this.retryAttempts[key] >= ENV.maxRetries) {
                        this.retryAttempts[key] = 0;
                        throw error;
                    }

                    // Exponential backoff with jitter
                    const delay = ENV.retryDelay * Math.pow(2, this.retryAttempts[key]) +
                                 Math.random() * 1000;

                    await new Promise(resolve => setTimeout(resolve, delay));
                    return this.retry(fn, context, attempt + 1);
                }
            }
        }

        const errorHandler = new ErrorHandler();

        // ========== UI Feedback System ==========
        class UIFeedback {
            showConnectionStatus(status, message) {
                const banner = document.getElementById('connectionStatus');
                const statusMessage = document.getElementById('statusMessage');
                const icon = banner.querySelector('.status-icon');

                statusMessage.textContent = message;
                banner.className = `connection-status show ${status}`;
                icon.className = `status-icon ${status}`;

                if (status === 'online' || status === 'development') {
                    setTimeout(() => {
                        banner.classList.remove('show');
                    }, 3000);
                }
            }

            showError(element, errorInfo, productId = null) {
                const errorDiv = document.createElement('div');
                errorDiv.className = `error-message ${errorInfo.severity || 'info'}`;

                // Fun action buttons based on error type
                let actionButtons = '';
                if (errorInfo.action === 'retry') {
                    actionButtons = `
                        <button class="error-action-btn primary" onclick="location.reload()">
                            üîÑ Try Again
                        </button>
                        <button class="error-action-btn" onclick="this.closest('.error-message').remove()">
                            Maybe Later
                        </button>
                    `;
                } else if (errorInfo.action === 'fallback' && productId) {
                    actionButtons = `
                        <button class="error-action-btn primary" onclick="this.closest('.error-message').remove()">
                            üçå Got It!
                        </button>
                    `;
                }

                errorDiv.innerHTML = `
                    <div class="error-message-title">${errorInfo.title || 'üêµ Oops!'}</div>
                    <div class="error-message-text">
                        ${errorInfo.message || 'Something went bananas!'}
                        ${errorInfo.subtitle ? `<br><small style="opacity: 0.9">${errorInfo.subtitle}</small>` : ''}
                    </div>
                    ${actionButtons ? `<div class="error-message-actions">${actionButtons}</div>` : ''}
                `;

                if (element) {
                    // Remove any existing error messages
                    element.querySelectorAll('.error-message').forEach(el => el.remove());
                    element.appendChild(errorDiv);

                    // Auto-remove after 15 seconds unless it has action buttons
                    if (!actionButtons) {
                        setTimeout(() => errorDiv.remove(), 15000);
                    }
                }
            }

            showProductSkeleton(container, count = 6) {
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'product-skeleton skeleton';
                    container.appendChild(skeleton);
                }
            }

            showDevBadge() {
                if (ENV.isDevelopment) {
                    const badge = document.getElementById('devBadge');
                    badge.classList.remove('hidden');
                    badge.onclick = () => {
                        alert(`Development Mode\n\nEnvironment: ${window.location.hostname}\nAPI: ${ENV.checkoutApiUrl}\nStripe: ${connectionState.stripeConfigured ? 'Configured' : 'Not Configured'}`);
                    };
                }
            }
        }

        const uiFeedback = new UIFeedback();

        // ========== Connection Monitoring ==========
        class ConnectionMonitor {
            constructor() {
                this.setupListeners();
                this.checkInitialState();
            }

            setupListeners() {
                window.addEventListener('online', () => this.handleConnectionChange(true));
                window.addEventListener('offline', () => this.handleConnectionChange(false));

                // Check API availability every 30 seconds
                setInterval(() => this.checkApiHealth(), 30000);
            }

            handleConnectionChange(isOnline) {
                connectionState.online = isOnline;

                if (isOnline) {
                    uiFeedback.showConnectionStatus('online', 'Connection restored');
                    this.checkApiHealth();
                    if (products.length === 0) {
                        loadProducts();
                    }
                } else {
                    uiFeedback.showConnectionStatus('offline', 'No internet connection - Some features may be limited');
                }
            }

            async checkInitialState() {
                if (!navigator.onLine) {
                    uiFeedback.showConnectionStatus('offline', 'No internet connection');
                    return;
                }

                if (ENV.isDevelopment) {
                    uiFeedback.showConnectionStatus('development',
                        'Development Mode - Using test configuration');
                }

                await this.checkApiHealth();
            }

            async checkApiHealth() {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);

                    const response = await fetch(ENV.checkoutApiUrl, {
                        method: 'OPTIONS',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    connectionState.apiAvailable = response.ok;
                    connectionState.lastCheck = Date.now();

                    if (!response.ok && ENV.isDevelopment) {
                        console.warn('Checkout API not responding - Using fallback mode');
                    }
                } catch (error) {
                    connectionState.apiAvailable = false;
                    if (ENV.isDevelopment) {
                        console.warn('Checkout API health check failed:', error);
                    }
                }
            }
        }

        // Initialize connection monitoring
        const connectionMonitor = new ConnectionMonitor();

        // ========== Product Loading with Error Handling ==========
        async function loadProducts() {
            const container = document.getElementById('products');

            try {
                // Show loading skeletons
                uiFeedback.showProductSkeleton(container);

                // Attempt to load products with retry
                const response = await errorHandler.retry(
                    async () => {
                        const res = await fetch('products.json');
                        if (!res.ok) throw new Error(`Failed to load products: ${res.status}`);
                        return res;
                    },
                    { key: 'loadProducts' }
                );

                products = await response.json();

                // Add placeholder image for missing product images
                products = products.map(product => ({
                    ...product,
                    image: product.image || 'images/placeholder_product.png'
                }));

                initializeCategories();
                renderFilterPills();
                renderProducts();
                initializeSearch(); // Initialize search functionality

                // Show dev badge if in development
                uiFeedback.showDevBadge();

            } catch (error) {
                const errorInfo = errorHandler.handle(error, { action: 'loadProducts' });

                container.innerHTML = `
                    <div class="no-results">
                        <h3>${errorInfo.title}</h3>
                        <p>${errorInfo.message}</p>
                        <button class="retry-button" onclick="loadProducts()">
                            Try Again
                        </button>
                        ${ENV.isDevelopment ? `
                            <p style="margin-top: 1rem; color: #666; font-size: 0.85rem;">
                                Dev Mode: Check console for details
                            </p>
                        ` : ''}
                    </div>
                `;
            }
        }

        // Initialize categories with counts
        function initializeCategories() {
            categories = { all: products.length };
            products.forEach(product => {
                const category = product.category || 'other';
                categories[category] = (categories[category] || 0) + 1;
            });
        }

        // Render filter pills
        function renderFilterPills() {
            const container = document.getElementById('filterPills');
            container.innerHTML = '';

            // Category display names
            const categoryNames = {
                'all': 'All Products',
                'hoodies': 'Hoodies',
                't-shirts': 'T-Shirts',
                'stickers': 'Stickers',
                'hangings': 'Wall Art',
                'notebooks': 'Notebooks'
            };

            Object.entries(categories).forEach(([category, count]) => {
                const pill = document.createElement('button');
                pill.className = `filter-pill ${category === 'all' ? 'active' : ''}`;
                pill.dataset.category = category;
                pill.innerHTML = `
                    <span>${categoryNames[category] || category}</span>
                    <span class="filter-count">${count}</span>
                `;
                pill.addEventListener('click', () => filterProducts(category));
                container.appendChild(pill);
            });
        }

        // Filter products with animation
        function filterProducts(category) {
            if (activeFilter === category) return;

            // Update active filter
            activeFilter = category;

            // Update pill states
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.toggle('active', pill.dataset.category === category);
            });

            // Show/hide clear button
            document.getElementById('clearFilter').style.display =
                category === 'all' ? 'none' : 'block';

            // Animate products
            const productElements = document.querySelectorAll('.product');
            let visibleCount = 0;

            productElements.forEach((element, index) => {
                const product = products[index];
                const shouldShow = category === 'all' || product.category === category;

                if (shouldShow) {
                    visibleCount++;
                    // Stagger the animation
                    setTimeout(() => {
                        element.classList.remove('hidden');
                        element.classList.add('filtering');
                    }, visibleCount * 50);
                } else {
                    element.classList.add('hidden');
                    element.classList.remove('filtering');
                }
            });

            // Show no results message if needed
            const container = document.getElementById('products');
            const noResultsElement = container.querySelector('.no-results');

            if (visibleCount === 0) {
                if (!noResultsElement) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.innerHTML = `
                        <h3>No products found</h3>
                        <p>Try selecting a different category</p>
                    `;
                    container.appendChild(noResults);
                }
            } else if (noResultsElement) {
                noResultsElement.remove();
            }
        }

        // ========== Product Search Functionality ==========
        let searchQuery = '';
        let searchDebounceTimer = null;

        // Search products by name, fit, or category
        function searchProducts(query) {
            searchQuery = query.toLowerCase().trim();

            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            const searchInfo = document.getElementById('searchInfo');
            const searchCount = document.getElementById('searchCount');

            // Show/hide clear button
            if (searchClear) {
                searchClear.style.display = searchQuery ? 'flex' : 'none';
            }

            // Get all product elements
            const productElements = document.querySelectorAll('.product');
            let visibleCount = 0;
            let matchedProducts = [];

            productElements.forEach((element, index) => {
                const product = products[index];
                let matches = false;

                // Check if search query is empty
                if (!searchQuery) {
                    // If no search, apply category filter only
                    matches = activeFilter === 'all' || product.category === activeFilter;
                } else {
                    // Search in product name
                    const nameMatch = product.name.toLowerCase().includes(searchQuery);

                    // Search in fit description
                    const fitMatch = product.fit && product.fit.toLowerCase().includes(searchQuery);

                    // Search in category
                    const categoryMatch = product.category.toLowerCase().includes(searchQuery);

                    // Search in price (e.g., "58" or "$58")
                    const priceMatch = product.price.toString().includes(searchQuery.replace('$', ''));

                    // Combine all matches
                    matches = nameMatch || fitMatch || categoryMatch || priceMatch;

                    // Also apply category filter if active
                    if (matches && activeFilter !== 'all') {
                        matches = product.category === activeFilter;
                    }
                }

                if (matches) {
                    visibleCount++;
                    matchedProducts.push(product);
                    // Stagger animation
                    setTimeout(() => {
                        element.classList.remove('hidden');
                        element.classList.add('filtering');
                    }, visibleCount * 50);
                } else {
                    element.classList.add('hidden');
                    element.classList.remove('filtering');
                }
            });

            // Update search info
            if (searchInfo && searchCount) {
                if (searchQuery) {
                    searchCount.textContent = `Found ${visibleCount} ${visibleCount === 1 ? 'item' : 'items'}`;
                    searchInfo.style.display = 'block';
                } else {
                    searchInfo.style.display = 'none';
                }
            }

            // Show/hide no results message
            const container = document.getElementById('products');
            const noResultsElement = container.querySelector('.no-results');

            if (visibleCount === 0) {
                if (!noResultsElement) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üôà</div>
                            <h3 style="margin-bottom: 10px; font-size: 24px;">No monkeys found!</h3>
                            <p style="color: #666; margin-bottom: 20px;">
                                ${searchQuery
                                    ? `No products match "${searchQuery}"`
                                    : 'No products in this category'}
                            </p>
                            <button
                                onclick="clearSearch()"
                                style="background: #000; color: #fff; border: none; padding: 12px 24px; font-size: 14px; font-weight: 700; letter-spacing: 0.1em; cursor: pointer; transition: all 0.3s ease;"
                            >
                                CLEAR SEARCH
                            </button>
                        </div>
                    `;
                    container.appendChild(noResults);
                }
            } else if (noResultsElement) {
                noResultsElement.remove();
            }

            // Log search for analytics (development only)
            if (ENV.isDevelopment && searchQuery) {
                console.log('Search:', {
                    query: searchQuery,
                    results: visibleCount,
                    matchedProducts: matchedProducts.map(p => p.name)
                });
            }
        }

        // Clear search
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
                searchProducts('');
                searchInput.focus();
            }
        }

        // Handle search input with debouncing (300ms delay)
        function handleSearchInput(event) {
            const query = event.target.value;

            // Clear previous timer
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }

            // Set new timer for debounced search
            searchDebounceTimer = setTimeout(() => {
                searchProducts(query);
            }, 300); // 300ms debounce
        }

        // Initialize search functionality
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');

            if (searchInput) {
                // Add input event listener with debouncing
                searchInput.addEventListener('input', handleSearchInput);

                // Add keyboard shortcuts
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        clearSearch();
                    } else if (e.key === 'Enter') {
                        // Immediately search on Enter (bypass debounce)
                        if (searchDebounceTimer) {
                            clearTimeout(searchDebounceTimer);
                        }
                        searchProducts(searchInput.value);
                    }
                });

                // Focus management
                searchInput.addEventListener('focus', () => {
                    searchInput.parentElement.classList.add('focused');
                });

                searchInput.addEventListener('blur', () => {
                    searchInput.parentElement.classList.remove('focused');
                });
            }

            if (searchClear) {
                searchClear.addEventListener('click', clearSearch);
            }

            // Keyboard shortcut: Ctrl/Cmd + K to focus search
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
            });
        }

        // Clear filter
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('clearFilter').addEventListener('click', () => {
                filterProducts('all');
            });
        });

        // Render products
        function renderProducts() {
            const container = document.getElementById('products');
            container.innerHTML = '';

            products.forEach((product, index) => {
                const productEl = document.createElement('div');
                productEl.className = 'product';
                productEl.dataset.category = product.category;
                productEl.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" loading="lazy" data-index="${index}">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">$${product.price} USD</div>
                        ${product.fit ? `<div class="product-fit">${product.fit}</div>` : ''}
                        <div class="size-selector" id="sizes-${product.id}">
                            ${Object.entries(product.sizes).map(([size, data]) => `
                                <button 
                                    class="size-btn ${data.soldOut ? 'sold-out' : ''}"
                                    data-product="${product.id}"
                                    data-size="${size}"
                                    data-sku="${data.skuId}"
                                    data-price="${data.priceId}"
                                    ${data.soldOut ? 'disabled' : ''}
                                >
                                    ${size}
                                </button>
                            `).join('')}
                        </div>
                        <button 
                            class="buy-btn" 
                            id="buy-${product.id}"
                            data-product="${product.id}"
                            disabled
                        >
                            SELECT SIZE
                        </button>
                        <div id="error-${product.id}"></div>
                    </div>
                `;
                container.appendChild(productEl);
            });

            // Add event listeners
            document.querySelectorAll('.size-btn:not(.sold-out)').forEach(btn => {
                btn.addEventListener('click', selectSize);
            });

            document.querySelectorAll('.buy-btn').forEach(btn => {
                btn.addEventListener('click', handleCheckout);
            });

            // Add lightbox click handlers to product images
            document.querySelectorAll('.product img').forEach(img => {
                img.addEventListener('click', openLightbox);
            });

            // Restore cart after products are rendered
            setTimeout(() => {
                restoreCart();
            }, 100); // Small delay to ensure DOM is fully ready
        }

        // Handle size selection
        function selectSize(e) {
            const productId = e.target.dataset.product;
            const size = e.target.dataset.size;

            // Clear previous selection
            document.querySelectorAll(`#sizes-${productId} .size-btn`).forEach(btn => {
                btn.classList.remove('selected');
            });

            // Select new size
            e.target.classList.add('selected');
            selectedSizes[productId] = {
                size: size,
                skuId: e.target.dataset.sku,
                priceId: e.target.dataset.price
            };

            // Save cart to localStorage
            cartPersistence.saveCart(selectedSizes);

            // Update buy button
            const buyBtn = document.getElementById(`buy-${productId}`);
            buyBtn.disabled = false;
            buyBtn.textContent = `BUY - SIZE ${size}`;
        }

        // Clear cart functionality
        function clearCart() {
            // Clear in-memory cart
            selectedSizes = {};

            // Clear localStorage
            cartPersistence.clearCart();

            // Reset all UI elements
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            document.querySelectorAll('.buy-btn').forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'SELECT SIZE';
            });

            // Show monkey-themed feedback
            const cartClearedInfo = {
                title: 'üçå Cart Cleared!',
                message: 'The monkeys cleaned out your banana basket!',
                severity: 'success'
            };

            // Show notification at top of products section
            const productsContainer = document.getElementById('products');
            if (productsContainer) {
                const tempDiv = document.createElement('div');
                tempDiv.style.gridColumn = '1 / -1';
                uiFeedback.showError(tempDiv, cartClearedInfo);
                productsContainer.insertBefore(tempDiv, productsContainer.firstChild);

                // Auto-remove after 3 seconds
                setTimeout(() => {
                    tempDiv.remove();
                }, 3000);
            }

            console.log('Cart cleared successfully');
        }

        // Restore cart from localStorage
        function restoreCart() {
            const savedCart = cartPersistence.loadCart();

            if (!savedCart || Object.keys(savedCart).length === 0) {
                return false;
            }

            // Restore selectedSizes
            selectedSizes = savedCart;

            // Restore UI state for each saved item
            let restoredCount = 0;
            Object.entries(savedCart).forEach(([productId, sizeData]) => {
                // Find and select the size button
                const sizeBtn = document.querySelector(
                    `button[data-product="${productId}"][data-size="${sizeData.size}"]`
                );

                if (sizeBtn && !sizeBtn.classList.contains('sold-out')) {
                    sizeBtn.classList.add('selected');

                    // Update buy button
                    const buyBtn = document.getElementById(`buy-${productId}`);
                    if (buyBtn) {
                        buyBtn.disabled = false;
                        buyBtn.textContent = `BUY - SIZE ${sizeData.size}`;
                    }

                    restoredCount++;
                }
            });

            // Show visual feedback if items were restored
            if (restoredCount > 0) {
                const cartAge = cartPersistence.getCartAge();
                const ageText = cartAge < 1 ?
                    'a few moments ago' :
                    `${Math.floor(cartAge)} hour${Math.floor(cartAge) !== 1 ? 's' : ''} ago`;

                const restoreInfo = {
                    title: 'üêµ Your Cart is Back!',
                    message: `We found ${restoredCount} item${restoredCount !== 1 ? 's' : ''} you picked ${ageText}!`,
                    subtitle: 'Cart saved for 24 hours - grab your bananas before they expire!',
                    severity: 'info'
                };

                // Show at top of products
                const productsContainer = document.getElementById('products');
                if (productsContainer) {
                    const tempDiv = document.createElement('div');
                    tempDiv.style.gridColumn = '1 / -1';
                    uiFeedback.showError(tempDiv, restoreInfo);
                    productsContainer.insertBefore(tempDiv, productsContainer.firstChild);

                    // Auto-remove after 8 seconds
                    setTimeout(() => {
                        tempDiv.remove();
                    }, 8000);
                }

                console.log(`Cart restored: ${restoredCount} items from ${ageText}`);
                return true;
            }

            return false;
        }

        // ========== Enhanced Checkout Handling ==========
        async function handleCheckout(e) {
            const productId = e.target.dataset.product;
            const selectedSize = selectedSizes[productId];

            if (!selectedSize) {
                return;
            }

            const product = products.find(p => p.id === productId);
            const buyBtn = e.target;
            const errorDiv = document.getElementById(`error-${productId}`);

            // Clear previous errors
            errorDiv.innerHTML = '';

            // Show loading state
            buyBtn.classList.add('loading');
            buyBtn.disabled = true;

            try {
                // Check if we're in development mode without API
                if (ENV.isDevelopment && !connectionState.apiAvailable) {
                    throw new Error('Development mode - Checkout API not configured');
                }

                // Attempt checkout with retry mechanism
                const response = await errorHandler.retry(
                    async () => {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);

                        const res = await fetch(ENV.checkoutApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                productId: productId,
                                skuId: selectedSize.skuId,
                                priceId: selectedSize.priceId
                            }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        return res;
                    },
                    { key: `checkout-${productId}` }
                );

                const data = await response.json();

                if (data.error) {
                    if (data.error.includes('sold out')) {
                        const soldOutInfo = {
                            title: 'üôà Another Monkey Got It First!',
                            message: 'This item just went bananas and sold out!',
                            subtitle: 'Refreshing the jungle inventory...',
                            severity: 'warning'
                        };
                        uiFeedback.showError(errorDiv, soldOutInfo);
                        setTimeout(() => window.location.reload(), 3000);
                    } else {
                        throw new Error(data.error);
                    }
                } else if (data.checkoutUrl) {
                    // Success - clear cart and redirect
                    // Clear the specific item from cart (or entire cart on successful checkout)
                    delete selectedSizes[productId];
                    cartPersistence.saveCart(selectedSizes);

                    // Show quick success before redirect
                    const successInfo = {
                        title: 'üéâ Banana Success!',
                        message: 'Swinging you to checkout...',
                        severity: 'success'
                    };
                    uiFeedback.showError(errorDiv, successInfo);
                    setTimeout(() => {
                        window.location.href = data.checkoutUrl;
                    }, 500);
                }

            } catch (error) {
                const errorInfo = errorHandler.handle(error, {
                    action: 'checkout',
                    productId
                });

                // Show fun error message
                uiFeedback.showError(errorDiv, errorInfo, productId);

                // Handle fallback redirect with countdown
                if (product.fallbackLink) {
                    // Add size to fallback URL if selected
                    let fallbackUrl = product.fallbackLink;
                    if (selectedSize && selectedSize.size) {
                        fallbackUrl += `&size=${encodeURIComponent(selectedSize.size)}`;
                    }

                    let countdown = 3;
                    const countdownInterval = setInterval(() => {
                        const countdownEl = errorDiv.querySelector('.countdown');
                        if (countdownEl) {
                            countdownEl.textContent = countdown;
                            countdown--;
                            if (countdown < 0) {
                                clearInterval(countdownInterval);
                                window.location.href = fallbackUrl;
                            }
                        }
                    }, 1000);

                    // Update message with countdown
                    setTimeout(() => {
                        const messageText = errorDiv.querySelector('.error-message-text');
                        if (messageText) {
                            messageText.innerHTML += `
                                <br><strong style="font-size: 1.2em">
                                    üçå Swinging to checkout info in <span class="countdown">3</span>...
                                </strong>
                            `;
                        }
                    }, 100);
                }
            } finally {
                buyBtn.classList.remove('loading');
                buyBtn.disabled = false;
            }
        }

        // ========== Mobile Payment Detection ==========
        if (window.PaymentRequest) {
            console.log('Payment Request API available - Apple Pay/Google Pay supported');
            connectionState.mobilePaymentsAvailable = true;
        }

        // Lightbox functionality
        let currentImageIndex = 0;

        function openLightbox(e) {
            const index = parseInt(e.target.dataset.index);
            currentImageIndex = index;
            updateLightboxImage();
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateLightboxImage() {
            const product = products[currentImageIndex];
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxCaption = document.getElementById('lightbox-caption');
            const prevBtn = document.getElementById('lightbox-prev');
            const nextBtn = document.getElementById('lightbox-next');

            lightboxImage.src = product.image;
            lightboxImage.alt = product.name;
            lightboxCaption.textContent = `${product.name} - $${product.price} USD`;

            // Update navigation buttons
            if (currentImageIndex === 0) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }

            if (currentImageIndex === products.length - 1) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }
        }

        function navigateLightbox(direction) {
            if (direction === 'prev' && currentImageIndex > 0) {
                currentImageIndex--;
                updateLightboxImage();
            } else if (direction === 'next' && currentImageIndex < products.length - 1) {
                currentImageIndex++;
                updateLightboxImage();
            }
        }

        // Lightbox event listeners
        document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
        document.getElementById('lightbox').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLightbox();
            }
        });

        document.getElementById('lightbox-prev').addEventListener('click', function(e) {
            e.stopPropagation();
            navigateLightbox('prev');
        });

        document.getElementById('lightbox-next').addEventListener('click', function(e) {
            e.stopPropagation();
            navigateLightbox('next');
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('lightbox').classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeLightbox();
                } else if (e.key === 'ArrowLeft') {
                    navigateLightbox('prev');
                } else if (e.key === 'ArrowRight') {
                    navigateLightbox('next');
                }
            } else {
                // Global keyboard shortcuts (when lightbox is not active)
                // Ctrl+Shift+C or Cmd+Shift+C to clear cart
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    if (Object.keys(selectedSizes).length > 0) {
                        const confirmed = confirm(
                            'üçå Clear all selected items from your banana basket?'
                        );
                        if (confirmed) {
                            clearCart();
                        }
                    }
                }
            }
        });

        // Prevent lightbox image from closing when clicked
        document.getElementById('lightbox-image').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Expose clearCart function globally for dev/testing
        window.fancyMonkeyCart = {
            clear: clearCart,
            restore: restoreCart,
            getCart: () => selectedSizes,
            getAge: () => {
                const age = cartPersistence.getCartAge();
                return age ? `${age.toFixed(1)} hours` : 'No cart saved';
            },
            getExpiry: () => {
                const timeLeft = cartPersistence.getTimeUntilExpiry();
                if (!timeLeft) return 'No cart saved';
                const hoursLeft = timeLeft / (1000 * 60 * 60);
                return `${hoursLeft.toFixed(1)} hours remaining`;
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', loadProducts);

        // Prevent image saving on iOS
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>